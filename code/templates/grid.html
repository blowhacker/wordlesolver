<!doctype html>
<title>Wordle solver</title>

<style>
    * {
        font-family: 'Clear Sans', 'Helvetica Neue', Arial, sans-serif;
    }
    
    table td {
        border: 2px solid #ddd;
        padding: 0px;
        margin: 3px;
    }
    
    .cell,
    .td_cell {
        height: 60px;
        width: 60px;
        text-transform: uppercase;
        font-size: 32px;
        line-height: 32px;
        font-weight: 700;
        user-select: none;
        justify-content: center;
        vertical-align: middle;
        box-sizing: border-box;
        display: inline-flex;
        align-items: center;
    }
    
    .orange {
        background-color: #c9b458;
        color: white;
    }
    
    .green {
        background-color: #6aaa64;
        color: white;
    }
    
    .grey {
        background-color: #86888a;
        color: white;
    }
    
    .white {
        background-color: white;
        color: black;
    }
    
    button.reset {
        margin-top: 20px;
    }
    
    #iphone_keyboard_show {
        position: absolute;
        opacity: 0;
    }
</style>

<body>
    <input type='text' id='iphone_keyboard_show'>
    <div onclick='document.getElementById("iphone_keyboard_show").focus();' id="main"></div>

    <button class="reset" onclick="reset()">Reset [Esc key]</button>

    <h3>Words <span id="word_count"></span><span id="loading"></span></h1>
        <div>
            <input type="radio" name="sort_by" id="sort_by_position" checked value="bypos"><label for="sort_by_position">Sort by letter position and frequency</label>
            <input type="radio" name="sort_by" id="sort_by_frequency" value="byfreq"><label for="sort_by_frequency">Sort by letter frequency</label>
        </div>

        <ul id="words">

        </ul>
</body>

<script>
    const rows = 6;
    const cols = 5;

    function drawGrid() {
        let grid = document.createElement('table')
        let str = ''
        for (let i = 0; i < rows; i++) {
            str += `<tr id="row_${i}">`
            for (let j = 0; j < cols; j++) {
                str += `<td id="cell_${i}_${j}" class="td_cell"></td>`
            }
            str += '</tr>'
        }
        grid.innerHTML = str
        document.getElementById('main').appendChild(grid)
    }
    drawGrid()

    function getIJ(cursorPos) {
        let i = Math.floor(cursorPos / cols)
        let j = cursorPos % cols

        return [i, j]
    }

    let cursorPos = 0
    document.onkeydown = function(e) {
        e = e || window.event;
        let keyCode = e.which || e.keyCode

        if (keyCode <= "Z".charCodeAt(0) && keyCode >= "A".charCodeAt(0)) {
            [i, j] = getIJ(cursorPos)
            let ele = document.getElementById(`cell_${i}_${j}`)
            ele.innerHTML = String.fromCharCode(keyCode);
            ele.classList.add('grey')
                //match row above if green
            let eleAbove = document.getElementById(`cell_${i - 1}_${j}`)
            if (eleAbove) {
                if (ele.innerText == eleAbove.innerText && eleAbove.classList.contains('green')) {
                    ele.classList.add('green')
                    ele.classList.remove('grey')
                } else {
                    let oranges = []
                    document.querySelectorAll('.orange').forEach(e => oranges.push(e.innerText))
                    if (oranges.indexOf(ele.innerText) !== -1) {
                        cssGridColourClasses.forEach(c => ele.classList.remove(c))
                        ele.classList.add('orange')
                    }
                }
            }


            cursorPos++
            if (cursorPos > rows * cols) {
                cursorPos = rows * cols
            }
        }
        if (keyCode == 8) { //backspace
            cursorPos--
            if (cursorPos < 0) {
                cursorPos = 0
            }
            [i, j] = getIJ(cursorPos)
            document.getElementById(`cell_${i}_${j}`).innerHTML = "";
            cssGridColourClasses.forEach(function(className) {
                document.getElementById(`cell_${i}_${j}`).classList.remove(className)
            })
        }

        if (keyCode == 32) { //space
            [i, j] = getIJ(cursorPos - 1)
            let ele = document.getElementById(`cell_${i}_${j}`)
            if (ele) {
                rotateStyle(ele)
            }
        }
        if (keyCode == 27) { //esc
            reset()
        }
    }
    let cssGridColourClasses = ['grey', 'orange', 'green', 'white']

    function rotateStyle(dis) {
        let found = false
        for (let i = 0; i < cssGridColourClasses.length; i++) {
            let clName = cssGridColourClasses[i]
            if ([...dis.classList].indexOf(clName) > -1) {
                dis.classList.remove(clName)
                dis.classList.add(cssGridColourClasses[(i + 1) % cssGridColourClasses.length])
                found = true;
                break
            }
        }
        if (dis.innerHTML === '') {
            cssGridColourClasses.forEach(clName => {
                dis.classList.remove(clName)
            })
        } else if (!found) {
            dis.classList.add(cssGridColourClasses[0])
        }
    }

    document.querySelectorAll('.td_cell').forEach(ele => {
        ele.addEventListener('click', () => {
            rotateStyle(ele)
        }, false);
    })


    lastQs = ""

    function getWords() {

        let strInclude = ''
        let exclude_pos = []

        document.querySelectorAll('.orange').forEach(ele => {
            let pos = parseInt(ele.id.split('_')[2])
            let d = {}
            d[pos] = ele.innerText.toLowerCase()
            exclude_pos.push(d)
            strInclude += ele.innerText.toLowerCase()
        })

        let include_pos = {}
        document.querySelectorAll('.green').forEach(ele => {
            let pos = parseInt(ele.id.split('_')[2])
            include_pos[pos] = ele.innerText.toLowerCase()
        })

        let exclude = ""
        document.querySelectorAll('.grey').forEach(ele => {
            let char = ele.innerText.toLowerCase()
            let goodToAdd = false
            if (Object.values(include_pos).indexOf(char) == -1) {
                goodToAdd = true
            }
            exclude_pos.forEach(item => {
                if (Object.values(item)[0] == char) {
                    goodToAdd = false
                }
            })
            if (goodToAdd) {
                exclude += char
            }
        })


        let params = {
            include: [...new Set(strInclude)].join('').toLowerCase(),
            exclude: exclude,
            exclude_pos: JSON.stringify(exclude_pos),
            include_pos: JSON.stringify(include_pos),
            sort_by_pos: document.querySelector("input[name=sort_by]:checked").value,
        }

        if (JSON.stringify(params) === lastQs) {
            return
        }
        lastQs = JSON.stringify(params)

        params['nonce'] = `${new Date() / 1}${Math.random()}`


        let qs = "?" + Object.keys(params).map(k => k + "=" + encodeURIComponent(params[k])).join("&")

        let eleLoading = document.getElementById('loading')
        eleLoading.innerHTML = "loading..."

        fetch("/solve" + qs)
            .then(response => response.json())
            .then(data => {
                if (params.nonce != data.nonce) {
                    console.log("stale nonce")
                    return
                }
                document.querySelector("#words").innerHTML = ''
                data.words.forEach(word => {
                    let li = document.createElement("li")
                    li.innerText = word
                    document.querySelector("#words").appendChild(li)
                })
                document.querySelector("#word_count").innerHTML = new Intl.NumberFormat('en-GB').format(data.words.length)
                eleLoading.innerHTML = ""
            })
    }

    setInterval(getWords, 100)
    setInterval(() => {
        [i, j] = getIJ(cursorPos)
        document.getElementById('iphone_keyboard_show').style.top = document.getElementById(`cell_${i}_1`).getBoundingClientRect().y

    }, 100)

    function reset() {
        window.location.href = window.location.href;
    }
</script>
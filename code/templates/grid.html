<!doctype html>
<title>Wordle solver</title>

<style>
    * {
        font-family: 'Menlo', 'Lucida Console';
    }
    
    body {
        width: 100vw;
    }
    
    table td {
        border: 2px solid #ddd;
        padding: 0px;
        margin: 3px;
    }
    
    @media only screen and (min-device-width: 375px) and (max-device-width: 812px) and (-webkit-min-device-pixel-ratio: 3) and (orientation: portrait) {
        table {
            zoom: 200%;
            margin: 0 auto;
        }
        #non_grid {
            zoom: 150%;
        }
        #sort_controls {
            float: right;
        }
    }
    
    .cell,
    .td_cell {
        height: 60px;
        width: 60px;
        text-transform: uppercase;
        font-size: 32px;
        line-height: 32px;
        font-weight: 700;
        user-select: none;
        justify-content: center;
        vertical-align: middle;
        box-sizing: border-box;
        display: inline-flex;
        align-items: center;
    }
    
    .orange {
        background-color: #c9b458;
        color: white;
    }
    
    .green {
        background-color: #6aaa64;
        color: white;
    }
    
    .grey {
        background-color: #86888a;
        color: white;
    }
    
    .white {
        background-color: white;
        color: black;
    }
    
    button.reset {
        margin-top: 20px;
    }
    
    #iphone_keyboard_show {
        position: absolute;
        opacity: 0;
    }
    
    #loading {
        padding-left: 25px;
        color: #777;
    }
    
    ul#words {
        font-size: 20px
    }
    
    ul#words li {
        cursor: pointer;
        width: 100px;
    }
    
    ul#words li:hover {
        background-color: #eee;
    }
</style>

<body>
    <input type='text' id='iphone_keyboard_show' type="text" autocomplete="off" autocorrect="off" autocapitalize="off">
    <div id="main"></div>
    <div id="non_grid">
        <h3>Words <span id="word_count"></span><span id="loading"></span></h1>
            <div id="sort_controls">
                <input type="checkbox" id="wordlist" value="wordle_all">
                <label for="wordlist">All Wordle allowed words</label> <br>
                <br> Algorithm:
                <select name="algorithm" id="algorithm">
                    <option value="combo_num_words">Proprietary</option>
                    <option value="position_and_frequency">Frequency & Position</option>
                    <option value="frequency">Frequency</option>
                    <option value="entropy">Entropy</option>
                  </select>
            </div>

            <ul id="words">

            </ul>
    </div>
</body>

<script>
    const rows = 6;
    const cols = 5;

    function drawGrid() {
        let grid = document.createElement('table')
        let str = ''
        for (let i = 0; i < rows; i++) {
            str += `<tr id="row_${i}">`
            for (let j = 0; j < cols; j++) {
                str += `<td id="cell_${i}_${j}" class="td_cell"></td>`
            }
            str += '</tr>'
        }
        grid.innerHTML = str
        document.getElementById('main').appendChild(grid)
    }
    drawGrid()

    function getIJ(cursorPos) {
        let i = Math.floor(cursorPos / cols)
        let j = cursorPos % cols

        return [i, j]
    }

    function enterChar(char) {
        [i, j] = getIJ(cursorPos)
        let ele = document.getElementById(`cell_${i}_${j}`)
        ele.innerHTML = char;
        ele.classList.add('grey')
            //match row above if green
        let eleAbove = document.getElementById(`cell_${i - 1}_${j}`)
        if (eleAbove) {
            if (ele.innerText == eleAbove.innerText && eleAbove.classList.contains('green')) {
                ele.classList.add('green')
                ele.classList.remove('grey')
            } else {
                let oranges = []
                document.querySelectorAll('.orange').forEach(e => oranges.push(e.innerText))
                if (oranges.indexOf(ele.innerText) !== -1) {
                    cssGridColourClasses.forEach(c => ele.classList.remove(c))
                    ele.classList.add('orange')
                }
            }
        }


        cursorPos++
        if (cursorPos > rows * cols) {
            cursorPos = rows * cols
        }
    }

    let cursorPos = 0
    document.onkeydown = function(e) {
        e = e || window.event;
        let keyCode = e.which || e.keyCode

        if (e.altKey || e.ctrlKey || e.metaKey) {
            return
        }
        if (keyCode <= "6".charCodeAt(0) && keyCode >= "1".charCodeAt(0)) {
            if (cursorPos > 0) {
                [i, j] = getIJ(cursorPos - 1)
                j = keyCode - "1".charCodeAt(0)
                rotateStyle(document.getElementById(`cell_${i}_${j}`))
            }
        }

        if (keyCode <= "Z".charCodeAt(0) && keyCode >= "A".charCodeAt(0)) {
            enterChar(String.fromCharCode(keyCode))
        }
        if (keyCode == 8) { //backspace
            cursorPos--
            if (cursorPos < 0) {
                cursorPos = 0
            }
            [i, j] = getIJ(cursorPos)
            document.getElementById(`cell_${i}_${j}`).innerHTML = "";
            cssGridColourClasses.forEach(function(className) {
                document.getElementById(`cell_${i}_${j}`).classList.remove(className)
            })
        }

        if (keyCode == 32) { //space // pretty useless as space causes scrolling
            [i, j] = getIJ(cursorPos - 1)
            let ele = document.getElementById(`cell_${i}_${j}`)
            if (ele) {
                rotateStyle(ele)
            }
        }
        if (keyCode == 27) { //esc
            reset()
        }
    }
    let cssGridColourClasses = ['grey', 'orange', 'green', 'white']

    function rotateStyle(dis) {
        let found = false
        for (let i = 0; i < cssGridColourClasses.length; i++) {
            let clName = cssGridColourClasses[i]
            if ([...dis.classList].indexOf(clName) > -1) {
                dis.classList.remove(clName)
                dis.classList.add(cssGridColourClasses[(i + 1) % cssGridColourClasses.length])
                found = true;
                break
            }
        }
        if (dis.innerHTML === '') {
            cssGridColourClasses.forEach(clName => {
                dis.classList.remove(clName)
            })
        } else if (!found) {
            dis.classList.add(cssGridColourClasses[0])
        }
    }

    document.querySelectorAll('.td_cell').forEach(ele => {
        ele.addEventListener('click', () => {
            rotateStyle(ele)
        }, false);
    })


    lastQs = ""

    function getWords() {

        let orangeTitles = []

        document.querySelectorAll('.orange').forEach(ele => {
            let pos = parseInt(ele.id.split('_')[2])
            let d = {}
            d[pos] = ele.innerText.toLowerCase()
            orangeTitles.push(d)
        })

        let greenTiles = {}
        document.querySelectorAll('.green').forEach(ele => {
            let pos = parseInt(ele.id.split('_')[2])
            greenTiles[pos] = ele.innerText.toLowerCase()
        })

        let greyTiles = ""
        document.querySelectorAll('.grey').forEach(ele => {
            let char = ele.innerText.toLowerCase()
            let goodToAdd = false
            if (Object.values(greenTiles).indexOf(char) == -1) {
                goodToAdd = true
            }
            orangeTitles.forEach(item => {
                if (Object.values(item)[0] == char) {
                    goodToAdd = false
                }
            })
            if (goodToAdd) {
                greyTiles += char
            }
        })

        let params = {
            green: JSON.stringify(greenTiles),
            orange: JSON.stringify(orangeTitles),
            grey: JSON.stringify([...greyTiles]),
            algorithm: document.querySelector("#algorithm").value,
            wordlist: document.querySelector("#wordlist:checked") ? 'wordle_all' : 'full',
        }

        if (JSON.stringify(params) === lastQs) {
            return
        }
        lastQs = JSON.stringify(params)

        params['nonce'] = `${new Date() / 1}${Math.random()}`

        let qs = "?" + Object.keys(params).map(k => k + "=" + encodeURIComponent(params[k])).join("&")

        let eleLoading = document.getElementById('loading')
        eleLoading.innerHTML = "loading..."

        fetch("/solve" + qs)
            .then(response => response.json())
            .then(data => {
                if (params.nonce != data.nonce) {
                    console.log("stale nonce")
                    return
                }
                document.querySelector("#words").innerHTML = ''
                Object.keys(data.words).forEach(word => {
                    let li = document.createElement("li")
                    li.innerText = word
                    li.title = `Score: ${data.words[word]}`
                    li.addEventListener('click', function() {
                        [i, j] = getIJ(cursorPos)
                        cursorPos = i * cols;
                        [...this.innerText].forEach(enterChar);
                        showKeyboard()
                    })
                    document.querySelector("#words").appendChild(li)
                })
                document.querySelector("#word_count").innerHTML = new Intl.NumberFormat('en-GB').format(Object.keys(data.words).length);
                eleLoading.innerHTML = ""
            })
    }

    function showKeyboard() {
        document.getElementById("iphone_keyboard_show").focus()
    }

    document.getElementById("main").addEventListener('click', showKeyboard)

    setInterval(getWords, 100)
    setInterval(() => {
        [i, j] = getIJ(cursorPos);
        document.getElementById('iphone_keyboard_show').style.top =
            document.getElementById(`cell_${i}_1`).getBoundingClientRect().y + "px"

    }, 100)

    function reset() {
        window.location.href = window.location.href;
    }
</script>